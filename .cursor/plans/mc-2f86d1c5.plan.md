<!-- 2f86d1c5-a722-4859-b951-3a35ebb43fc5 9d4ae90c-a718-4ad8-99f2-ba9b18251ff9 -->
# MCDF MVP — Functional Implementation Plan

Target stack: Laravel 11, PHP 8.3, Livewire 3 (Volt for pages), Eloquent, Tailwind/Flux UI. Auth via Fortify.

## Increment 1: Membership Management

- Data: `members` table (fields per spec), soft deletes, indexes on `registration_no`, `state_id`, `lga_id`, `status`.
- Routes (Volt): `members.index`, `members.create`, `members.edit/{member}`, `members.show/{member}`.
- Livewire (Volt) pages:
- List with filters (status, state/LGA, search name/reg no) and pagination.
- Create/Edit form (validation rules, unique `registration_no`, derived `eligibility_start_date`).
- Show profile with tabs: Overview, Dependents, Contributions, Loans, Activity.
- Policies: `MemberPolicy` (viewAny, view, create, update, delete) mapped to roles.
- Acceptance:
- Create member with valid data persists and redirects to Show with success message.
- Filters return correct subsets; no N+1 on list/show.

## Increment 1b: Dependents

- Data: `dependents` table with FK to `members`, fields: name, DOB, relationship enum, `nin` CHAR(11) (11-digit National ID), soft deletes. Indexes on (`member_id`), unique index on `nin` (nullable allowed if no NIN).
- UI: Tab on Member Show to add/edit/remove dependents (inline table + modal form). NIN field with input mask and server validation.
- Validation: `relationship` in ['spouse','child','other']; `nin` nullable|digits:11|unique:dependents,nin; if provided must be exactly 11 digits.
- Rules: child `eligible` derived by age ≤ 15; member inactivity may affect dependent eligibility.
- Acceptance:
- Adding dependent with valid 11-digit NIN persists and is unique among dependents; deleting is soft delete.

## Increment 2: Contribution Management

- Data: `contribution_plans`, `contributions`, `fund_ledger` (inflows for contributions).
- `contributions` fields include: `member_id`, `contribution_plan_id`, `amount`, `payment_method` (cash/transfer), `payment_ref` (nullable, unique when present), `payment_date`, `receipt_path` (nullable), `status` enum('submitted','pending_review','approved','rejected','paid') default 'submitted', `reviewed_by` (nullable), `reviewed_at` (nullable), `fine_amount`, `receipt_notes`.
- Routes: `contributions.index`, `contributions.submit` (member-facing), `contributions.review` (finance queue), `contributions.batch-upload`.
- UI:
- Member submission: select plan, amount, date, method, optional reference, upload receipt image/PDF (max 5MB), submit. Shows "pending review" status.
- Finance review queue: list of `pending_review`/`submitted` with filters; open detail → preview receipt, compare amount/date, set decision: Approve (status→`approved`), Reject (status→`rejected`, reason).
- Approval flow: on Approve, create/confirm `fund_ledger` inflow and mark contribution `paid` (or keep `approved` and derive paid in reports). On Reject, no ledger entry.
- History per member (on Member Show) with totals and export CSV.
- Batch import (CSV) with idempotency by composite (member_id, payment_date, amount) when `payment_ref` is absent; if present, still de-dup by `payment_ref`.
- Domain services:
- `ContributionService`:
- `submit(member, dto)` handles validation, storage of receipt to `storage/app/public/receipts`, sets status `submitted` → `pending_review` automatically.
- `review(contribution, decision, reviewer, reason?)` performs approve/reject, sets reviewer fields, creates ledger inflow on approve, computes fine.
- `isDuplicate(dto)` checks by `payment_ref` if present, else by (member_id, payment_date, amount) within a 3-day window.
- Validation & Files:
- `payment_ref`: nullable|string|max:100|unique:contributions,payment_ref,NULL,id
- `receipt`: nullable|file|mimes:jpg,jpeg,png,pdf|max:5120
- Acceptance:
- A member can submit a contribution with no `payment_ref` and a receipt; it appears in the Finance queue.
- Approving a submission records a `fund_ledger` inflow and sets status `paid/approved`; rejecting does not create a ledger entry and stores reason.
- Batch import skips duplicates when `payment_ref` missing by using composite heuristic.

## Increment 3: Loan Management

- Data: `loans`, `loan_repayments`, add ledger entries for repayments.
- Workflow states: pending → approved → disbursed → repaid/defaulted.
- UI:
- Member applies (basic form) — optional for MVP; staff can create on behalf.
- Review queue for Finance Officer; approve/reject with remarks.
- Disbursement record (date/amount), schedule display, repayment entry form.
- Loan balance calculation = approved - sum(repayments).
- Policy checks (role-based) on approve/disburse.
- Acceptance:
- Approving sets `approved_by` and `date_approved`; disbursement locks status; repayments reduce balance and write `fund_ledger` inflow.

## Increment 4: Health Eligibility

- Data: `health_eligibilities` (member-only for MVP) or compute on the fly.
- Rules: eligibility true if days since `registration_date` ≥ settings.wait_days AND contributions up-to-date (simple plan-based check).
- UI:
- Eligibility check page: search member → show Eligible/Not Eligible with rule explanation.
- Dependent eligibility derived from member (and age for children).
- Acceptance:
- Changing contributions can flip eligibility; page reflects updated status.

## Increment 5: Reporting

- Pages:
- Contribution summary (by period, plan, LGA/state) with totals; export CSV.
- Loan performance (counts, disbursed, outstanding, defaulted) with date range; export CSV.
- Dependent summary by age/relationship.
- Implementation: Eloquent + optimized aggregates (selectRaw, groupBy), streamed CSV exports.
- Acceptance:
- Reports match sample fixtures; exports stream in O(1) memory.

## Increment 6: System Administration

- Users/Roles: basic user list, create/deactivate, assign roles (Admin, Finance, Health, Member).
- Policies wired to resources; middleware gates routes.
- Settings: key-value `settings` table with form for financial rules (wait days, fines, rates).

## Cross-cutting

- Navigation: add top-level menu items (Members, Contributions, Loans, Health, Reports, Admin) in `layouts/app/sidebar.blade.php` and header.
- Validation: Form Requests for controllers (if any) and Livewire rules; server-side errors surfaced in UI.
- Feedback: Use Alert/Toast plan for success/error messaging.
- Auditing: `audit_logs` written on create/update/approve/disburse/repay.
- Testing: Feature tests per increment; factories for members, contributions, loans.

## Key Files/Artifacts

- Models: `Member`, `Dependent`, `ContributionPlan`, `Contribution`, `FundLedger`, `Loan`, `LoanRepayment`, `Setting`.
- Policies: `MemberPolicy`, `LoanPolicy`, `UserPolicy`.
- Services: `ContributionService`, `LoanService`, `EligibilityService`.
- Livewire (Volt) pages under `resources/views/livewire/{module}/...`.

## Minimal Schema (migrations highlights)

- Add FK indexes: (`member_id`), (`loan_id`), (`state_id`,`lga_id`), unique on `members.registration_no`, unique on `contributions.payment_ref`.

## Acceptance Demo Data

- Seeder to create 50 members, 100 contributions, 5 loans with repayments for report verification.

### To-dos

- [ ] Create Toast container and Alert Blade components
- [ ] Add Livewire trait for dispatching toast events
- [ ] Include toast container in app layouts
- [ ] Write feature tests for flash alerts and dusk tests for toasts